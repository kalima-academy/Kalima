<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Jeu Kalima - Certificat</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root { --bg-color: #FFFFFF; --brand-red: #5D1828; --brand-gold: #C8A462; --card-white: #FFFFFF; }
    * { box-sizing: border-box; }

    body {
      background-color: var(--bg-color);
      color: var(--brand-red);
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden; /* √©vite micro d√©calage horizontal iOS */
    }

    /* ‚úÖ FIX: centrage fiable du ‚Äúlivre‚Äù (emoji) + pas de glissement */
    .book-container {
      width: 90px; height: 90px;
      background: linear-gradient(135deg, #ffffff, #f0f0f0);
      border-radius: 50%;
      display: grid;
      place-items: center;
      box-shadow: 0 10px 25px rgba(200, 164, 98, 0.3);
      margin: 0 auto 15px auto;
      border: 4px solid var(--brand-gold);
      font-size: 3rem;
      animation: float 3s ease-in-out infinite;
      line-height: 1;
      transform: translateZ(0); /* iOS anti-jitter */
    }

    /* ‚úÖ FIX iOS: si emoji para√Æt ‚Äúd√©cal√©‚Äù optiquement */
    .book-container span { display:block; transform: translateX(-1px); }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
      100% { transform: translateY(0px); }
    }

    header { text-align: center; margin-bottom: 20px; width: 100%; }
    .title-text { font-family: 'Cinzel', serif; font-size: 2rem; color: var(--brand-red); font-weight: 700; }
    .subtitle { color: var(--brand-gold); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-top: 5px; }

    .learning-container { display: flex; gap: 10px; margin-bottom: 30px; justify-content: center; flex-direction: row-reverse; flex-wrap: wrap; }
    .learn-btn {
      width: 65px; height: 65px; border-radius: 50%;
      background-color: var(--brand-red); color: var(--brand-gold);
      border: 3px solid var(--brand-red);
      font-family: 'Amiri', serif; font-size: 1.8rem;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 4px 10px rgba(93, 24, 40, 0.3);
      transition: transform 0.1s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .learn-btn:active { transform: scale(0.9); background-color: var(--brand-gold); color: var(--brand-red); }

    .game-wrapper { width: 100%; max-width: 500px; display: none; animation: fadeIn 0.5s; }
    .instruction { text-align: center; margin-bottom: 20px; font-weight: 600; font-size: 1.1rem; line-height: 1.4; }

    .sound-trigger {
      background: var(--brand-gold); color: white; border: none;
      padding: 15px 20px; border-radius: 50px;
      font-size: 1.1rem; font-weight: 600;
      cursor: pointer; margin: 0 auto 25px auto;
      display: block; box-shadow: 0 5px 15px rgba(200, 164, 98, 0.4);
      width: 90%; transition: transform 0.1s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .sound-trigger:active { transform: scale(0.95); }

    .cards-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
    .card {
      background: var(--card-white);
      border-radius: 16px;
      width: 45%;
      aspect-ratio: 1;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 2px solid #f0f0f0;
      transition: transform 0.2s;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .card:active { transform: scale(0.95); }
    .card-letter { font-family: 'Amiri', serif; font-size: 3.5rem; color: var(--brand-red); }
    .card.correct { border: 3px solid #4CAF50 !important; background-color: #f1fcf2; }
    .card.wrong { border: 3px solid #f44336 !important; animation: shake 0.4s; }

    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    #start-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.98); z-index: 1000;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      text-align: center; padding: 20px;
    }

    .start-btn {
      background: linear-gradient(135deg, var(--brand-red), #3a0f19);
      color: var(--brand-gold);
      border: 2px solid var(--brand-gold);
      padding: 15px 40px;
      font-size: 1.3rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(93, 24, 40, 0.3);
      margin-top: 30px;
      animation: pulse 2s infinite;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    #victory-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.98); z-index: 100;
      flex-direction: column; justify-content: center; align-items: center;
      text-align: center; overflow-y: auto; padding: 20px;
    }

    .diploma-paper {
      border: 8px double var(--brand-gold);
      padding: 30px;
      border-radius: 15px;
      background: white;
      position: relative;
      margin-bottom: 20px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .diploma-paper:after {
      content: '‚òÖ'; position: absolute; bottom: 10px; right: 50%; transform: translateX(50%);
      color: var(--brand-gold); font-size: 2rem;
    }

    input.name-input {
      padding: 12px; border: 2px solid var(--brand-gold); border-radius: 8px;
      font-size: 1.1rem; width: 250px; text-align: center; margin-bottom: 20px;
      background: #fafafa;
    }

    @media print {
      body * { visibility: hidden; }
      #victory-modal, #victory-modal * { visibility: visible; }
      #victory-modal {
        position: absolute; left: 0; top: 0; width: 100%; height: 100%;
        background: white; display: flex; justify-content: center; align-items: center;
      }
      .diploma-paper {
        border: 10px double var(--brand-gold);
        width: 90%; max-width: 800px; height: auto;
        box-shadow: none;
      }
      .no-print, input.name-input, .sound-trigger { display: none !important; }
      #diploma-name-display {
        display: block !important; font-family: 'Amiri', serif;
        font-size: 2.5rem; color: var(--brand-red);
        margin: 20px 0; border-bottom: 1px solid #ccc;
      }
    }
  </style>
</head>

<body>

  <div id="start-overlay">
    <div class="book-container"><span>üìñ</span></div>
    <h1 style="color:var(--brand-red); margin:0;">KALIMA</h1>
    <p style="color:#666; margin-top:10px;">Le√ßon : Lettres (ÿ£ - ÿ´)</p>
    <button class="start-btn" onclick="startGame()">JOUER / JUGAR ‚ñ∂Ô∏è</button>
    <p style="font-size:0.8rem; color:#999; margin-top:20px;">(Active le son / Activa el sonido)</p>
  </div>

  <header>
    <div class="book-container" style="width:50px; height:50px; font-size:1.8rem; border-width:2px;"><span>üìñ</span></div>
    <div class="title-text">KALIMA</div>
    <div class="subtitle">ÿßŸÑÿ≠ÿ±ŸàŸÅ / Les Lettres</div>
  </header>

  <div class="learning-container" id="learning-container"></div>

  <div class="game-wrapper" id="game-ui">
    <div class="instruction">
      √âcoute et trouve !<br>
      <small>¬°Escucha y encuentra!</small>
    </div>
    <button class="sound-trigger" onclick="playCurrentChallenge()">üîä √âcouter / Escuchar</button>
    <div class="cards-grid" id="grid"></div>
    <div style="margin-top:20px; font-weight:bold; color:var(--brand-gold);">Score : <span id="score">0</span> / 4</div>
  </div>

  <div id="victory-modal">
    <input type="text" id="player-name" class="name-input" placeholder="Ton Pr√©nom / Tu Nombre" oninput="updateName(this.value)">

    <div class="diploma-paper">
      <div style="font-family:'Amiri'; font-size:4rem; color:var(--brand-gold); line-height:1;">ŸÖÿ®ÿ±ŸàŸÉ</div>
      <h2 style="color:var(--brand-red); font-size:2rem; margin:10px 0;">CERTIFICAT</h2>
      <p style="color:#666; margin:0;">Ce certificat est d√©cern√© √† :</p>
      <p style="color:#666; font-size:0.9rem;">Este certificado se otorga a:</p>

      <div id="diploma-name-display" style="font-family:'Amiri'; font-size:2.5rem; color:var(--brand-red); margin:15px 0;">...</div>

      <p style="font-weight:bold; color:var(--brand-red);">
        Pour avoir ma√Ætris√© le Groupe 1.<br>
        <span style="font-weight:normal; font-size:0.9rem; color:#666;">Por dominar el Grupo 1.</span>
      </p>
      <div style="margin-top:20px; font-size:2rem;">üìñ</div>
    </div>

    <button class="sound-trigger" style="background:var(--brand-red); margin-bottom:10px;" onclick="window.print()">üñ®Ô∏è Imprimer / Imprimir</button>
    <button class="sound-trigger" onclick="fullReset()">Rejouer / Jugar de nouveau ‚Ü∫</button>
  </div>

  <script>
    // --- CONFIGURATION DU GROUPE 1 (ÿ£ ÿ® ÿ™ ÿ´) ---
    const levels = [
      { char: 'ÿ£', speak: 'ÿ£ŸéŸÑŸêŸÅŸí', lang: 'ar-SA', rate: 0.8 },
      { char: 'ÿ®', speak: 'ÿ®Ÿéÿßÿ°Ÿí', lang: 'ar-SA', rate: 0.8 },
      { char: 'ÿ™', speak: 'ÿ™Ÿéÿßÿ°Ÿí', lang: 'ar-SA', rate: 0.8 },
      { char: 'ÿ´', speak: 'ÿ´Ÿéÿßÿ°Ÿí', lang: 'ar-SA', rate: 0.8 }
    ];

    let currentIndex = 0;
    let score = 0;
    let currentOrder = [];

    // ‚úÖ FIX iPhone: cache voices + wait for voices
    let cachedVoices = [];
    let voicesReady = false;

    function primeVoices() {
      cachedVoices = window.speechSynthesis.getVoices();
      if (cachedVoices.length) voicesReady = true;

      window.speechSynthesis.onvoiceschanged = () => {
        cachedVoices = window.speechSynthesis.getVoices();
        voicesReady = true;
      };
    }

    function pickVoiceFor(langCode) {
      const voices = (cachedVoices && cachedVoices.length) ? cachedVoices : window.speechSynthesis.getVoices();
      const lc = (langCode || '').toLowerCase();

      // 1) match exact prefix ar-SA, fr-FR etc.
      let v = voices.find(x => (x.lang || '').toLowerCase().startsWith(lc));
      if (v) return v;

      // 2) fallback: for Arabic, accept ANY "ar"
      if (lc.startsWith('ar')) {
        v = voices.find(x => (x.lang || '').toLowerCase().startsWith('ar'));
        if (v) return v;
      }

      // 3) fallback default voice
      v = voices.find(x => x.default);
      return v || null;
    }

    // --- MOTEUR AUDIO (robuste iOS) ---
    function playAudio(text, langCode, speed) {
      if (!('speechSynthesis' in window)) return;

      // iOS: cancel to avoid stuck queue/silence
      window.speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);

      // ‚úÖ iOS: "ar" est souvent plus tol√©rant que "ar-SA"
      const safeLang = (langCode && langCode.toLowerCase().startsWith('ar')) ? 'ar' : (langCode || 'fr-FR');
      utterance.lang = safeLang;
      utterance.rate = speed || 0.9;

      const voice = pickVoiceFor(langCode || safeLang);
      if (voice) utterance.voice = voice;

      // micro d√©lai iOS
      setTimeout(() => window.speechSynthesis.speak(utterance), 30);
    }

    // --- D√âMARRAGE ---
    function startGame() {
      document.getElementById('start-overlay').style.display = 'none';
      document.getElementById('game-ui').style.display = 'block';

      // ‚úÖ iOS unlock + prime voices on a user gesture
      primeVoices();
      playAudio(' ', 'fr-FR', 1.0);

      initGame();
    }

    // --- INITIALISATION DU JEU ---
    function initLearningButtons() {
      const container = document.getElementById('learning-container');
      container.innerHTML = '';
      levels.forEach(item => {
        const btn = document.createElement('div');
        btn.className = 'learn-btn';
        btn.innerText = item.char;
        btn.onclick = function() {
          playAudio(item.speak, item.lang, item.rate);
          this.style.transform = "scale(0.9)";
          setTimeout(() => this.style.transform = "scale(1)", 150);
        };
        container.appendChild(btn);
      });
    }

    function initGame() {
      initLearningButtons();
      currentOrder = [...levels].sort(() => Math.random() - 0.5);
      currentIndex = 0;
      score = 0;
      document.getElementById('score').innerText = score;
      loadLevel();
    }

    function fullReset() {
      document.getElementById('victory-modal').style.display = 'none';
      document.getElementById('game-ui').style.display = 'block';
      document.getElementById('player-name').value = '';
      document.getElementById('diploma-name-display').innerText = '...';
      initGame();
    }

    function updateName(val) {
      document.getElementById('diploma-name-display').innerText = val || "...";
    }

    function loadLevel() {
      if (currentIndex >= currentOrder.length) {
        showVictory();
        return;
      }

      const target = currentOrder[currentIndex];
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      const displayCards = [...levels].sort(() => Math.random() - 0.5);

      displayCards.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div class="card-letter">${item.char}</div>`;

        card.onclick = function() {
          if (item.char === target.char) {
            card.classList.add('correct');
            score++;
            document.getElementById('score').innerText = score;
            setTimeout(() => {
              currentIndex++;
              loadLevel();
            }, 800);
          } else {
            card.classList.add('wrong');
            if (navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => card.classList.remove('wrong'), 500);
          }
        };

        grid.appendChild(card);
      });

      setTimeout(() => playCurrentChallenge(), 600);
    }

    function playCurrentChallenge() {
      if (currentIndex < currentOrder.length) {
        const item = currentOrder[currentIndex];
        playAudio(item.speak, item.lang, item.rate);
      }
    }

    function showVictory() {
      document.getElementById('game-ui').style.display = 'none';
      document.getElementById('victory-modal').style.display = 'flex';

      // ‚úÖ Mabrouk moins robotique: essayer fran√ßais d'abord (souvent meilleure voix sur iOS)
      // Si tu veux absolument arabe, change en: playAudio("ŸÖÿ®ÿ±ŸàŸÉ", "ar-SA", 0.9);
      playAudio("Mabrouk", "fr-FR", 1.0);

      launchConfetti();
    }

    function launchConfetti() {
      const duration = 3000;
      const end = Date.now() + duration;
      (function frame() {
        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#C8A462', '#5D1828'] });
        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#C8A462', '#5D1828'] });
        if (Date.now() < end) requestAnimationFrame(frame);
      }());
    }
  </script>
</body>
</html>
